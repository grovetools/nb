package service

import (
	"os"
	"path/filepath"
	"testing"

	"github.com/mattsolo1/nb/pkg/models"
	"github.com/mattsolo1/nb/pkg/workspace"
)

func TestNewService(t *testing.T) {
	tmpDir := t.TempDir()
	config := &Config{
		DataDir:     tmpDir,
		Editor:      "vim",
		DefaultType: models.NoteTypeCurrent,
	}

	svc, err := New(config)
	if err != nil {
		t.Fatalf("Failed to create service: %v", err)
	}
	defer svc.Close()

	if svc.Config.DataDir != tmpDir {
		t.Errorf("Expected DataDir %s, got %s", tmpDir, svc.Config.DataDir)
	}
}

func TestListNotes(t *testing.T) {
	tmpDir := t.TempDir()
	config := &Config{
		DataDir:     filepath.Join(tmpDir, "data"),
		Editor:      "vim",
		DefaultType: models.NoteTypeCurrent,
	}

	svc, err := New(config)
	if err != nil {
		t.Fatalf("Failed to create service: %v", err)
	}
	defer svc.Close()

	// Create workspace directory
	wsDir := filepath.Join(tmpDir, "workspace")
	os.MkdirAll(wsDir, 0755)
	
	// Make it a proper workspace by creating .nb directory
	os.MkdirAll(filepath.Join(wsDir, ".nb"), 0755)
	
	// Register workspace - use absolute path
	absWsDir, _ := filepath.Abs(wsDir)
	ws := &workspace.Workspace{
		Name:        "test",
		Path:        absWsDir,
		Type:        workspace.TypeDirectory,
		NotebookDir: filepath.Join(tmpDir, "notebooks"),
	}
	if err := svc.Registry.Add(ws); err != nil {
		t.Fatalf("Failed to register workspace: %v", err)
	}
	
	// Create test notes directory 
	notesDir := filepath.Join(tmpDir, "notebooks", "test", "current")
	if err := os.MkdirAll(notesDir, 0755); err != nil {
		t.Fatalf("Failed to create notes dir: %v", err)
	}

	// Create test note files
	testNotes := []string{
		"20240101-test-note-1.md",
		"20240102-test-note-2.md",
		"20240103-test-note-3.md",
	}

	for _, filename := range testNotes {
		content := `---
title: Test Note
type: current
created_at: 2024-01-01T10:00:00Z
modified_at: 2024-01-01T10:00:00Z
---

# Test Note

This is a test note.
`
		if err := os.WriteFile(filepath.Join(notesDir, filename), []byte(content), 0644); err != nil {
			t.Fatalf("Failed to create test note: %v", err)
		}
	}

	// Change to workspace directory
	oldDir, _ := os.Getwd()
	defer os.Chdir(oldDir)
	os.Chdir(absWsDir)

	// Verify workspace detection
	cwd, _ := os.Getwd()
	t.Logf("Changed to directory: %s", cwd)
	
	// Try FindByPath directly
	foundWs, err := svc.Registry.FindByPath(cwd)
	if err != nil {
		t.Logf("FindByPath error: %v", err)
	} else if foundWs != nil {
		t.Logf("FindByPath found: %s (path: %s)", foundWs.Name, foundWs.Path)
	} else {
		t.Logf("FindByPath returned nil")
	}
	
	detectedWs, err := svc.Registry.DetectCurrent()
	if err != nil {
		t.Logf("Warning: Failed to detect workspace: %v", err)
	} else if detectedWs != nil {
		t.Logf("Detected workspace: %s (path: %s)", detectedWs.Name, detectedWs.Path)
	}

	notes, err := svc.ListNotes(models.NoteTypeCurrent)
	if err != nil {
		t.Fatalf("ListNotes failed: %v", err)
	}

	if len(notes) != len(testNotes) {
		// Debug: check if files exist
		files, _ := os.ReadDir(notesDir)
		t.Logf("Files in %s: %d", notesDir, len(files))
		for _, f := range files {
			t.Logf("  - %s", f.Name())
		}
		
		// Debug: check current directory
		cwd, _ := os.Getwd()
		t.Logf("Current directory: %s", cwd)
		
		t.Errorf("Expected %d notes, got %d", len(testNotes), len(notes))
	}
}

func TestArchiveNotes(t *testing.T) {
	tmpDir := t.TempDir()
	config := &Config{
		DataDir:     filepath.Join(tmpDir, "data"),
		Editor:      "vim",
		DefaultType: models.NoteTypeCurrent,
	}

	svc, err := New(config)
	if err != nil {
		t.Fatalf("Failed to create service: %v", err)
	}
	defer svc.Close()

	// Create workspace directory
	wsDir := filepath.Join(tmpDir, "workspace")
	os.MkdirAll(wsDir, 0755)
	
	// Make it a proper workspace by creating .nb directory
	os.MkdirAll(filepath.Join(wsDir, ".nb"), 0755)
	
	// Register workspace - use absolute path
	absWsDir, _ := filepath.Abs(wsDir)
	ws := &workspace.Workspace{
		Name:        "test",
		Path:        absWsDir,
		Type:        workspace.TypeDirectory,
		NotebookDir: filepath.Join(tmpDir, "notebooks"),
	}
	if err := svc.Registry.Add(ws); err != nil {
		t.Fatalf("Failed to register workspace: %v", err)
	}

	// Create test structure
	currentDir := filepath.Join(tmpDir, "notebooks", "test", "current")
	archiveDir := filepath.Join(tmpDir, "notebooks", "test", "archive")
	os.MkdirAll(currentDir, 0755)
	os.MkdirAll(archiveDir, 0755)

	// Create a test note
	testNote := filepath.Join(currentDir, "20240101-test-note.md")
	content := `---
title: Test Note
type: current
---

Test content
`
	if err := os.WriteFile(testNote, []byte(content), 0644); err != nil {
		t.Fatalf("Failed to create test note: %v", err)
	}

	// Change to workspace directory
	oldDir, _ := os.Getwd()
	defer os.Chdir(oldDir)
	os.Chdir(wsDir)

	// Archive the note
	err = svc.ArchiveNotes([]string{testNote})
	if err != nil {
		t.Fatalf("ArchiveNotes failed: %v", err)
	}

	// Check if note was moved
	if _, err := os.Stat(testNote); !os.IsNotExist(err) {
		t.Error("Original note still exists")
	}

	archivedNote := filepath.Join(archiveDir, "20240101-test-note.md")
	if _, err := os.Stat(archivedNote); os.IsNotExist(err) {
		t.Error("Archived note not found")
	}
}

func TestGetWorkspaceContext(t *testing.T) {
	tmpDir := t.TempDir()
	config := &Config{
		DataDir:     filepath.Join(tmpDir, "data"),
		Editor:      "vim",
		DefaultType: models.NoteTypeCurrent,
	}

	svc, err := New(config)
	if err != nil {
		t.Fatalf("Failed to create service: %v", err)
	}
	defer svc.Close()

	// Create a git workspace
	wsDir := filepath.Join(tmpDir, "test-repo")
	os.MkdirAll(filepath.Join(wsDir, ".git"), 0755)
	
	// Write HEAD file to simulate being on main branch
	headFile := filepath.Join(wsDir, ".git", "HEAD")
	if err := os.WriteFile(headFile, []byte("ref: refs/heads/main\n"), 0644); err != nil {
		t.Fatalf("Failed to write HEAD file: %v", err)
	}
	
	// Register workspace
	ws := &workspace.Workspace{
		Name:        "test-repo",
		Path:        wsDir,
		Type:        workspace.TypeGitRepo,
		NotebookDir: filepath.Join(tmpDir, "notebooks"),
	}
	if err := svc.Registry.Add(ws); err != nil {
		t.Fatalf("Failed to register workspace: %v", err)
	}
	
	// Create note directories
	os.MkdirAll(filepath.Join(tmpDir, "notebooks", "repos", "test-repo", "main", "current"), 0755)
	os.MkdirAll(filepath.Join(tmpDir, "notebooks", "repos", "test-repo", "main", "archive"), 0755)

	// Change to workspace
	oldDir, _ := os.Getwd()
	defer os.Chdir(oldDir)
	os.Chdir(wsDir)

	ctx, err := svc.GetWorkspaceContext()
	if err != nil {
		t.Fatalf("GetWorkspaceContext failed: %v", err)
	}

	if ctx.Branch != "main" {
		t.Errorf("Expected branch 'main', got %s", ctx.Branch)
	}

	if _, ok := ctx.Paths["current"]; !ok {
		t.Error("Expected 'current' path in context")
	}
}

func TestServiceConfig(t *testing.T) {
	tmpDir := t.TempDir()
	
	templates := map[string]string{
		"meeting": "# Meeting Notes\n\nDate: {{.Date}}\n\n## Attendees\n\n## Agenda\n\n## Notes\n",
		"review":  "# Code Review\n\nDate: {{.Date}}\n\n## Changes\n\n## Comments\n",
	}
	
	config := &Config{
		DataDir:     tmpDir,
		Editor:      "nvim",
		DefaultType: models.NoteTypeLearn,
		Templates:   templates,
	}

	svc, err := New(config)
	if err != nil {
		t.Fatalf("Failed to create service: %v", err)
	}
	defer svc.Close()

	// Test config values
	if svc.Config.Editor != "nvim" {
		t.Errorf("Expected editor 'nvim', got %s", svc.Config.Editor)
	}

	if svc.Config.DefaultType != models.NoteTypeLearn {
		t.Errorf("Expected default type 'learn', got %s", svc.Config.DefaultType)
	}

	if len(svc.Config.Templates) != 2 {
		t.Errorf("Expected 2 templates, got %d", len(svc.Config.Templates))
	}
}